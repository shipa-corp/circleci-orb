description: >
  Perform Canary deployment of app to shipa cluster.
parameters:
  appname:
    default: $SHIPA_APP_NAME
    description: Your shipa app name
    type: string
  user:
    default: $SHIPA_USER
    description: Your shipa user (email)
    type: string
  password:
    default: $SHIPA_PASSWORD
    description: Your shipa password
    type: string
  server:
    default: $SHIPA_SERVER
    description: Your shipa server URL (for example http://shipa-ci-integration.org:8080)
    type: string
  ca:
    default: $(echo $SHIPA_CA | base64 -d)
    description: Your shipa CA certificate (base64 encoded)
    type: string
  canary-steps:
    default: $SHIPA_CANARY_STEPS
    description: Canary steps
    type: string
  canary-interval:
    default: $SHIPA_CANARY_INTERVAL
    description: Canary interval
    type: string
  canary-step-weight:
    default: $SHIPA_CANARY_STEP_WEIGHT
    description: Canary step weight
    type: string
steps:
  - run:
      name: Deploy app to shipa cluster (with Canary deployment)
      command: |
        if [[ << parameters.ca >> == "" ]]; then
          shipa-ci \
          --server=<< parameters.server >> \
          --email=<< parameters.user >> \
          --password=<< parameters.password >> \
          --insecure app deploy \
          --app=<< parameters.appname >> \
          --steps=<< parameters.canary-steps >> \
          --step-interval=<< parameters.canary-interval >> \
          --step-weight=<< parameters.canary-step-weight >>
        else
          shipa-ci \
          --server=<< parameters.server >> \
          --email=<< parameters.user >> \
          --password=<< parameters.password >> \
          --ca="<< parameters.ca >>" \
          app deploy \
          --app=<< parameters.appname >> \
          --steps=<< parameters.canary-steps >> \
          --step-interval=<< parameters.canary-interval >> \
          --step-weight=<< parameters.canary-step-weight >>
        fi
